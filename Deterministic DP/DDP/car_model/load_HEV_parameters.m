
HEV.Gear_ratio = [3.1 1.81 1.41 1 0.71 0.61];
HEV.Axle_ratio = 4.1;


HEV.r_tire = 0.25;
HEV.m = 2500;
HEV.G = 9.8*HEV.m;
HEV.f_tire = 0.01;
HEV.Cd = 0.3;
HEV.A = 2;
HEV.delta_inertial = 1.05*[1 1 1 1 1 1];

HEV.idle_fc_rate = 0.1453; % g/s

Trans_shift_up_sta = 2200*2*pi/60/HEV.Axle_ratio./HEV.Gear_ratio*0.3*3.6;

Trans_shift_table_dmd = 0:10:100;
Trans_shiftup_table = [1600 1700 1800 1900 2100 2200 2400 2600 2800 3000 3200];
Trans_shiftdown_table = [900 1000 1000 1000 1000 1200 1200 1300 1550 1800 1800];

motor_eff_speed=[0;1000;2000;3000;4000];
motor_eff_torque = -200:20:200;
motor_eff_eff=[ 0.7 0.78 0.85 0.86 0.81;
0.7 0.78 0.86 0.87 0.82;
0.7 0.79 0.86 0.88 0.85;
0.7 0.80 0.86 0.89 0.87;
0.7 0.81 0.87 0.90 0.88;
0.7 0.82 0.88 0.90 0.9;
0.7 0.82 0.87 0.90 0.91;
0.7 0.82 0.86 0.90 0.91;
0.7 0.81 0.85 0.89 0.91;
0.7 0.77 0.82 0.87 0.88;
0.7 0.75 0.8  0.85 0.85;
0.7 0.77 0.82 0.87 0.88;
0.7 0.81 0.85 0.89 0.91;
0.7 0.82 0.86 0.90 0.91;
0.7 0.82 0.87 0.90 0.91;
0.7 0.82 0.88 0.90 0.9;
0.7 0.81 0.87 0.90 0.88;
0.7 0.80 0.86 0.89 0.87;
0.7 0.79 0.86 0.88 0.85;
0.7 0.78 0.86 0.87 0.82;
0.7 0.78 0.85 0.86 0.81]*1.09;

HEV.bat_q = 1.4*1000*3600; % 1.4 kWh
% HEV.bat_q = 1.4*1000*3600/2; % 0.7 kWh
bat_eff_soc = [0.1; 0.9];
bat_eff_dis = [0.65; 0.9];
bat_eff_cha = [0.9; 0.7];

test_result_torquetable = [
     0            -7.76906057   -24.7450341    -33.32266748           -34.55681333   -35.82696745   -37.21539021   -38.72024495           -40.31837452   -42.1468032    -44.22093287   -47.55022583           -59.87439139   -70.74069841   -76.7663187    -96.16514463          -121.0691506  ;             10.53352172    11.33409035     4.5713874     -0.99808245            -5.0946801     -9.47705692   -13.60192288   -17.15532687           -18.71783435   -19.23027289   -20.40870143   -23.20217423           -28.06742403   -33.50677648   -40.83853191   -57.86752278           -88.73444116 ;             10.52507371    39.03989531    34.76859097    34.63475112            39.18506917    43.76762979    49.47262396    55.11476146            59.72109113    63.26648219    66.56776534    66.83764583            63.94353499    62.09211669    59.51144929    49.52676754            21.4029489  ;             56.54035955    57.61809304    60.32462655    64.67458474            71.08608987    77.66991143    86.04847818    94.29218413           101.51469596   107.7895137    113.82796586   115.85791274           113.99422885   112.8967592    109.89103592   100.07744903            71.29936397 ;             67.27850431    75.34557916    82.42197648    89.88061208            98.30574027   107.0353747    118.07963519   128.80646586           138.56916314   146.96906848   155.11515074   158.56579618           156.98562363   156.98452596   153.49286431   144.73744808           112.15859358 ;             84.21013801    92.0899434    103.95330505   114.85767468           125.28417535   136.00973375   149.4909021    162.61120284           174.72263583   185.40810801   195.23902846   199.45875445           197.96162167   198.79862328   195.91116999   189.98616005           151.29512635 ;             99.34958865   109.60947113   127.07968438   141.50012486           153.63041085   167.13622198   183.49283879   199.67002561           214.28986299   226.69271889   238.49010916   243.89883404           242.2344796    242.93657093   241.86258814   239.06678048           193.48129054 ;            109.64385366   123.14838396   146.66022646   165.19632935           179.70978358   195.00005106   214.41651258   233.17091274           249.69298487   264.05630179   277.66672586   284.00543861           282.54842087   283.07639854   283.31262318   279.91647726           230.68454735 ;            116.79998808   134.3726674    164.97835134   189.16352876           206.10965837   223.00660138   244.90139659   265.91925567           285.30158399   301.21254214   315.45170934   322.53014607           324.66768746   323.21317513   324.77202011   320.5542728            262.39857023 ;            120.38575852   142.25366698   181.64331594   211.70045722           230.87346827   249.93624394   274.28100507   298.60942058           319.12605977   336.56438672   354.73894501   364.84822056           363.3001661    360.21846026   362.65626301   359.67003513           300.95687459 ;            121.14028549   145.78853941   190.03427067   224.7372464            245.12100238   265.48770872   292.28544985   317.44563663           338.57648404   358.4544583    377.9759019    385.69547204           383.401368     378.02307143   383.42709752   381.06463845           319.37059191 ;
];

test_result_fctable = [
     0.14529892  0.11925486  0.04442828  0.0         0.0                 0.0         0.0         0.0         0.0         0.0                 0.0         0.0         0.0         0.0         0.0                 0.0         0.0       ;          0.17663935  0.20969545  0.19727168  0.18784737  0.17779896          0.17102631  0.16919291  0.16506092  0.17177883  0.19189152          0.21309879  0.23033824  0.25195401  0.28008497  0.33189208          0.42276306  0.46589128;          0.17663935  0.35240904  0.3648683   0.38673838  0.45330867          0.52505078  0.60879895  0.69873143  0.79050072  0.8832654           0.98109245  1.06009378  1.11639564  1.2877803   1.527236            1.94343221  2.1430999 ;          0.39560826  0.43568098  0.49506132  0.57170334  0.67005031          0.74558733  0.86468412  0.9925883   1.16878528  1.30570894          1.45008936  1.56696447  1.65066474  1.83485581  2.25757605          2.87308499  3.16806072;          0.44612171  0.51363367  0.60512525  0.71090335  0.79771038          0.96495022  1.16467894  1.33685455  1.51234294  1.68949199          1.87628693  1.94794241  2.05195493  2.28120639  2.70547557          3.44177901  3.63302141;          0.50872471  0.60281249  0.73242556  0.87253189  0.97906411          1.1843131   1.37329053  1.57622831  1.78317651  1.99220935          2.21263482  2.39100204  2.5186433   2.79982297  3.32002028          4.22458409  4.65723013;          0.55196188  0.69513387  0.87026268  1.05024048  1.17843743          1.36476251  1.58268402  1.81671522  2.05523271  2.29598678          2.54985096  2.75531786  2.9024133   3.2264795   3.82605468          4.86783651  5.1177    ;          0.5975064   0.73447428  0.94896618  1.16027625  1.35979116          1.5015      1.741176    1.998564    2.260985    2.64927542          2.94235456  3.17951515  3.19336875  3.5497575   4.209               5.3559      5.9052    ;          0.600525    0.75531     1.01118     1.253826    1.469424            1.70175     1.973484    2.265306    2.5626925   2.8628325           3.1793125   3.43545     3.61881     4.0229295   4.77075             6.0696      6.6927    ;          0.61605     0.795855    1.107795    1.3939065   1.6336785           1.8920625   2.1940065   2.5182585   2.8488225   3.1826025           3.5345625   3.81937125  4.02319125  4.47239775  5.303625            6.7482      7.440825  ;          0.6192      0.81440625  1.15647749  1.475145    1.728795            2.002125    2.321703    2.664897    3.01475     3.36798             3.74045     4.0417875   4.2573375   4.732623    5.61225             7.1406      7.87395   ;
]; % g/s

test_table_pedal = [0;2;10;20;30;40;50;60;70;85;100];

test_table_speed = [750;  850;  950; 1050; 1150; 1250; 1350; 1450; 1550; 1650; 1750; 1850; 1950; 2150; 2500; 3000; 3500];


%% Interpolation 

[grid_motor_eff_torque,grid_motor_eff_speed] = ndgrid(motor_eff_torque,motor_eff_speed);
HEV.motor_eff_2d = griddedInterpolant(grid_motor_eff_torque,grid_motor_eff_speed,motor_eff_eff);

% test_eff = HEV.motor_eff_2d([100,100])

HEV.battery_eff_dis_1d = griddedInterpolant(bat_eff_soc,bat_eff_dis);

% test_eff = HEV.battery_eff_dis_1d(0.55)

HEV.battery_eff_cha_1d = griddedInterpolant(bat_eff_soc,bat_eff_cha);

HEV.up_shift_1d = griddedInterpolant(Trans_shift_table_dmd, Trans_shiftup_table);
HEV.down_shift_1d = griddedInterpolant(Trans_shift_table_dmd, Trans_shiftdown_table);

% test_up = HEV.up_shift_1d(20)

HEV.max_engine_torque_1d = griddedInterpolant(test_table_speed,test_result_torquetable(end,:));

%% Engine map

[grid_test_table_pedal,grid_test_table_speed] = ndgrid(test_table_pedal,test_table_speed);

HEV.engine_torque_2d = griddedInterpolant(grid_test_table_pedal,grid_test_table_speed,test_result_torquetable);
HEV.engine_fc_2d = griddedInterpolant(grid_test_table_pedal,grid_test_table_speed,test_result_fctable);

% test_torque = HEV.engine_torque_2d([40,1500])
% test_fc = HEV.engine_fc_2d([40,1500])

torque_grid = linspace(0,400,41);
fc_table = zeros(length(torque_grid),length(test_table_speed));
for i = 1:length(test_table_speed)
    rpm = test_table_speed(i);
    for j = 1:length(torque_grid)
        torque = torque_grid(j);
        pedal = func_torque_rpm_to_pedal(torque,rpm,HEV);
        fc = HEV.engine_fc_2d(pedal,rpm);
        fc_table(j,i) = fc;
    end
end

[grid_torque_grid,grid_test_table_speed_2] = ndgrid(torque_grid,test_table_speed);

HEV.engine_t_fc_2d = griddedInterpolant(grid_torque_grid,grid_test_table_speed_2,fc_table);


test_fc = HEV.engine_t_fc_2d(80,900);

% function pedal = torque_rpm_to_pedal(torque,rpm,HEV)
% %     if rpm < 800
% %         rpm = 800;
% %     elseif rpm > 3500
% %         rpm = 3500;
% %     end
% 
%     test_table_pedal = [0;2;10;20;30;40;50;60;70;85;100];
%     torque_at_pedal_grid = test_table_pedal*0;
%     for i = 1:length(test_table_pedal)
%         torque_at_pedal_grid(i) = HEV.engine_torque_2d(test_table_pedal(i),rpm);
%     end
%     pedal = interp1(torque_at_pedal_grid,test_table_pedal,torque);
%     if pedal >= 100
%         pedal = 100;
%     elseif pedal < 0
%         pedal = 0;
%     end
% end
